<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>GeoNames city search</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />

    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

      <!-- Mapbox CSS -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />

    <!-- Custom styles for this template -->
    <link href="css/styles.css" rel="stylesheet">

    <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>

    <!-- Algolia search libraries -->
    <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
	<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>

  </head>

  <body>

  	<div id="map"></div>
  	<div id="title-anchor">
  		<h1 class="highlight">GeoNames<br/>City Search</h1>
  	</div>

  	<div class="container h-100">
	    <div class="row h-100 justify-content-center align-items-center">
	        <div class="aa-input-container" id="aa-input-container">
			    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for a city..." name="search" autocomplete="off" />
			    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
			        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
			    </svg>
			</div>
	    </div>
	</div>

    

	<script>
		var client = algoliasearch('N3CD4LLDJP', 'a4741273f8f9925df313ae2bd90dd7b3');
		var index = client.initIndex('geonames');
		var currentCoordinates = [48.880388, 2.326423];
		var results = [];

		function showResult(suggestion) {
			if (suggestion.admin1) {
            	return '<span>' +
              		suggestion._highlightResult.name.value + ', ' + suggestion.admin1 + ', ' + suggestion.cc + '</span>';
            }

        	return '<span>' +
          		suggestion._highlightResult.name.value + ', ' + suggestion.cc + '</span>';
		}

		// initialize autocomplete on search input (ID selector must match).
		autocomplete('#aa-search-input',
		{ hint: false }, [
			 {
			    source: function(query, callback) {
				  index.search(query, { hitsPerPage: 2, aroundLatLng: currentCoordinates.join(',')}).then(function(answer) {
				  	results = answer.hits.map(x => x.geonameid);
				    callback(answer.hits);
				  }, function() {
				    callback([]);
				  });
				},
			    // value to be displayed in input control after user's suggestion selection.
			    displayKey: 'name',
			    // hash of templates used when rendering dataset.
			    templates: {
			        // 'suggestion' templating function used to render a single suggestion.
			        suggestion: function(suggestion) {
			        	return showResult(suggestion);
			        }
			    }
			},
			{
			    source: function(query, callback) {
				  index.search(query, { hitsPerPage: 5}).then(function(answer) {
				  	var hits = answer.hits.filter(x => !results.includes(x.geonameid));
				    callback(hits.slice(0, 5-results.length));
				  }, function() {
				    callback([]);
				  });
				},
			    // value to be displayed in input control after user's suggestion selection.
			    displayKey: 'name',
			    // hash of templates used when rendering dataset.
			    templates: {
			        // 'suggestion' templating function used to render a single suggestion.
			        suggestion: function(suggestion) {
			            return showResult(suggestion);
			        }
			    }
			}
		]).on('autocomplete:selected', function(event, suggestion, dataset) {
			var coordinates = [suggestion._geoloc.lng, suggestion._geoloc.lat];
			map.flyTo({center: coordinates, zoom: 9, bearing: 0, speed: 2, curve: 1});
		});

		mapboxgl.accessToken = 'pk.eyJ1IjoiYmVuc2xrIiwiYSI6ImVacUt6TzAifQ.Unm87871efLpgpZ3eLMe9g';

		var map = new mapboxgl.Map({
		    container: 'map', // container id.
		    style: 'mapbox://styles/mapbox/outdoors-v9', //stylesheet location.
		    center: currentCoordinates.reverse(), // starting position.
		    zoom: 13 // starting zoom.
		});

		map.on('moveend', function(event) {
			currentCoordinates = [map.getCenter().lat, map.getCenter().lng];
		});
	</script>
  </body>
</html>